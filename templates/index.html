<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoAI - AI Video Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #ffffff;
            margin-bottom: 40px;
            padding: 20px 0;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 20px;
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: #dc2626;
            transform: translateX(-5px);
        }

        .header-logo {
            max-width: 200px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            color: #cccccc;
        }

        .card {
            background: #0a0a0a;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(239, 68, 68, 0.3);
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #1a1a1a;
            color: #ffffff;
        }

        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #ef4444;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-stage {
            text-align: center;
            font-size: 18px;
            color: #ef4444;
            font-weight: 600;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .video-preview {
            width: 100%;
            max-width: 400px;
            max-height: 70vh;
            border-radius: 15px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .video-preview video {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
        }

        .download-btn {
            background: #10b981;
            margin-top: 20px;
        }

        .download-btn:hover {
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .error {
            background: #fee;
            border: 2px solid #f88;
            padding: 15px;
            border-radius: 10px;
            color: #c33;
            margin-top: 20px;
            display: none;
        }

        .feature-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            margin-bottom: 20px;
            justify-content: center;
            width: 100%;
        }

        .tag {
            background: rgba(251, 191, 36, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #fbbf24;
            border: 1px solid #fbbf24;
            font-weight: 500;
            flex: 1;
            text-align: center;
            min-width: 140px;
        }

        .example-topics {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .example-topic {
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .example-topic:hover {
            background: #e0e0e0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 15px 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .upload-area {
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f5f5ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            color: #666;
            font-size: 14px;
        }

        .file-name {
            margin-top: 10px;
            color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            .header {
                margin-bottom: 20px;
                padding: 10px 0;
            }

            .header-logo {
                max-width: 120px;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.95em;
            }
            
            .card {
                padding: 20px 15px;
                border-radius: 15px;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            /* Stack all form controls vertically on mobile */
            .options-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            /* Bigger touch targets */
            input[type="text"],
            select,
            textarea {
                padding: 14px 12px;
                font-size: 16px;
            }

            .btn {
                padding: 16px 30px;
                font-size: 17px;
                border-radius: 12px;
            }

            /* Better mobile upload areas */
            .upload-area {
                padding: 30px 15px;
                font-size: 15px;
            }

            .upload-label {
                font-size: 15px;
            }

            /* Compact section titles */
            .section-title {
                font-size: 16px;
                margin: 20px 0 12px 0;
                padding-bottom: 6px;
            }

            /* Mobile-friendly example topics */
            .example-topics {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .example-topic {
                font-size: 14px;
                padding: 8px 14px;
                width: 100%;
                text-align: center;
            }

            /* Hide showcase on mobile to save space */
            #showcaseSection {
                display: block;
            }
            
            /* Show showcase as compact thumbnail grid on mobile */
            #showcaseSection .showcase-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            #showcaseSection video {
                height: 200px;
                object-fit: cover;
            }

            /* Better progress display */
            .progress-container {
                margin-top: 20px;
            }

            .progress-bar {
                height: 35px;
            }

            .progress-stage {
                font-size: 16px;
            }

            /* Video preview sizing */
            .video-preview {
                max-width: 100%;
                border-radius: 10px;
                margin: 15px auto;
            }

            /* Feature tags wrap better */
            .feature-tags {
                gap: 8px;
            }

            .tag {
                font-size: 13px;
                padding: 6px 12px;
            }

            /* Adjust select dropdowns */
            select {
                background-position: right 8px center;
            }
        }

        /* Extra small phones */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .card {
                padding: 15px 10px;
            }

            .btn {
                font-size: 16px;
                padding: 14px 25px;
            }

            input[type="text"],
            select,
            textarea {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-button">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0L6.59 1.41 12.17 7H0v2h12.17l-5.58 5.59L8 16l8-8z" transform="rotate(180 8 8)"/>
                </svg>
                Back
            </a>
            <img src="/static/logo.png" alt="EchoAI" class="header-logo">
            <h1>üé¨ EchoAI</h1>
            <p>Create viral short-form videos with AI in minutes</p>
        </div>

        <div class="card">
            <form id="videoForm">
                <div class="form-group">
                    <label>Content Source</label>
                    <select id="content_source" onchange="toggleTopicSource()">
                        <option value="manual" selected>‚úçÔ∏è Write My Own Topic</option>
                        <option value="trending">üî• Trending Topics (Current Events)</option>
                        <option value="mystery">üïµÔ∏è Mystery Stories (Unsolved Cases)</option>
                        <option value="dark">üåë Dark Stories (True Crime, Paranormal)</option>
                    </select>
                </div>

                <div class="form-group" id="manualTopicSection">
                    <label>Your Story or Topic *</label>
                    <textarea 
                        id="topic" 
                        placeholder="Paste your full story here, or just enter a topic and AI will create the content.&#x0a;&#x0a;Examples:&#x0a;‚Ä¢ Full story: 'In 1995, three hikers vanished in the mountains. Days later, their tent was found cut from the inside...'&#x0a;‚Ä¢ Simple topic: 'The mystery of Malaysia Flight 370'&#x0a;‚Ä¢ Concept: 'Unexplained disappearances in national parks'"
                        required
                        style="min-height: 150px;"
                    ></textarea>
                    <div id="proTip" style="margin-top: 8px; font-size: 12px; color: #666;">
                        üí° <strong>Pro tip:</strong> <span id="proTipText" style="display:inline-block; transition: opacity 350ms ease; opacity:1;">Paste a full story for precise script, or just enter a topic/concept and let AI expand it</span>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="skip_ai" style="margin-right: 8px; cursor: pointer;">
                            <span>Skip AI generation (use existing audio/media files only)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; margin-top: 6px;">
                            <input type="checkbox" id="skip_captions" style="margin-right: 8px; cursor: pointer;">
                            <span>Skip captions (use uploaded audio only)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="fetchedTopicSection" style="display: none;">
                    <label>AI-Generated Stories <span style="float: right; font-size: 12px; color: #999;" id="storyCount"></span></label>
                    <div style="margin-bottom: 10px; padding: 10px; background: #f0f7ff; border-left: 3px solid #667eea; border-radius: 5px; font-size: 13px;">
                        üé® Each story is uniquely generated by AI - unlimited supply!
                    </div>
                    <select id="fetched_topic" size="8" style="height: 280px; font-size: 13px; line-height: 1.8; padding: 10px;">
                    </select>
                    <button type="button" class="btn" style="margin-top: 10px; font-size: 14px; padding: 10px 20px; background: #ef4444;" onclick="refreshStories()">
                        ‚ú® Generate Fresh Stories
                    </button>
                    <div id="story_preview" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 10px; border-left: 4px solid #667eea; display: none;">
                        <strong style="color: #667eea; font-size: 14px;">üìñ Story Preview:</strong>
                        <p id="story_preview_text" style="margin-top: 10px; color: #555; font-size: 13px; line-height: 1.6;"></p>
                        <div id="story_meta" style="margin-top: 10px; font-size: 12px; color: #999;"></div>
                    </div>
                </div>

                <div class="section-title">üé¨ Video Elements</div>
                <div class="form-group">
                    <label>Content Type</label>
                    <select id="content_type" onchange="toggleUploadSections()">
                        <option value="images" selected>Images Only (Auto-Generated)</option>
                        <option value="videos">Videos Only (Auto-Generated)</option>
                        <option value="combo">Combo: Images + Videos</option>
                        <option value="upload_images">Upload My Own Images</option>
                        <option value="upload_videos">Upload My Own Videos</option>
                        <option value="upload_both">Upload Images + Videos</option>
                    </select>
                </div>

                <div class="form-group" id="imageUploadSection" style="display: none;">
                    <label>Upload Images (JPG/PNG)</label>
                    <div class="upload-area" onclick="document.getElementById('imageFiles').click()">
                        <input type="file" id="imageFiles" accept="image/jpeg,image/png" multiple onchange="handleImageUpload(event)">
                        <span class="upload-label">üìÅ Click to upload images (multiple)</span>
                        <span class="file-name" id="imageFileNames"></span>
                    </div>
                </div>

                <div class="form-group" id="videoUploadSection" style="display: none;">
                    <label>Upload Videos (MP4)</label>
                    <div class="upload-area" onclick="document.getElementById('videoFiles').click()">
                        <input type="file" id="videoFiles" accept="video/mp4" multiple onchange="handleVideoUpload(event)">
                        <span class="upload-label">üìÅ Click to upload videos (multiple)</span>
                        <span class="file-name" id="videoFileNames"></span>
                    </div>
                </div>

                <div class="options-grid">
                    <div class="form-group">
                        <label>Video Style (AI writing tone)</label>
                        <select id="style">
                            <optgroup label="Standard Styles">
                                <option value="viral_facts">Viral Facts - Fast-paced, shocking, Gen-Z energy</option>
                                <option value="story_time">Story Time - Narrative arc with dramatic storytelling</option>
                                <option value="motivational">Motivational - Inspirational, empowering call-to-action</option>
                                <option value="educational">Educational - Clear step-by-step explanations</option>
                            </optgroup>
                            <optgroup label="Mystery & Dark Styles">
                                <option value="mystery_investigation">üïµÔ∏è Mystery Investigation - Detective-style breakdown</option>
                                <option value="true_crime">üîç True Crime - Documentary narration</option>
                                <option value="creepy_story">üëª Creepy Storytelling - Atmospheric horror</option>
                                <option value="conspiracy">ü§î Conspiracy Deep-Dive - Analytical investigation</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Voice</label>
                        <select id="voice">
                            <optgroup label="Male - US">
                                <option value="en-US-GuyNeural" selected>Guy (Deep, Confident)</option>
                                <option value="en-US-ChristopherNeural">Christopher (Warm, Friendly)</option>
                                <option value="en-US-EricNeural">Eric (Energetic, Young)</option>
                                <option value="en-US-RogerNeural">Roger (Mature, Authoritative)</option>
                            </optgroup>
                            <optgroup label="Female - US">
                                <option value="en-US-AriaNeural">Aria (Upbeat, Enthusiastic)</option>
                                <option value="en-US-JennyNeural">Jenny (Conversational, Warm)</option>
                                <option value="en-US-MichelleNeural">Michelle (Clear, Professional)</option>
                            </optgroup>
                            <optgroup label="British">
                                <option value="en-GB-RyanNeural">Ryan (Male, British)</option>
                                <option value="en-GB-SoniaNeural">Sonia (Female, British)</option>
                            </optgroup>
                            <optgroup label="Australian">
                                <option value="en-AU-WilliamNeural">William (Male, Australian)</option>
                                <option value="en-AU-NatashaNeural">Natasha (Female, Australian)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Custom Audio (Optional)</label>
                        <select id="audio_source" onchange="toggleAudioUpload()">
                            <option value="none" selected>No Custom Audio</option>
                            <option value="replace">Replace Voice with Music</option>
                            <option value="mix_quiet">Mix - Background Music (Quiet)</option>
                            <option value="mix_medium">Mix - Background Music (Medium)</option>
                            <option value="mix_loud">Mix - Background Music (Loud)</option>
                        </select>
                    </div>

                    <div class="form-group" id="audioUploadSection" style="display: none;">
                        <label>Upload Audio File (MP3/WAV)</label>
                        <div class="upload-area" onclick="document.getElementById('customAudioFile').click()">
                            <input type="file" id="customAudioFile" accept="audio/mp3,audio/wav,audio/mpeg" onchange="handleCustomAudioUpload(event)">
                            <span class="upload-label">üìÅ Click to upload audio</span>
                            <span class="file-name" id="customAudioFileName"></span>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            üí° Audio will be looped if shorter than video duration
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Duration</label>
                        <select id="duration">
                            <optgroup label="üì± Short-Form (15-90s)">
                                <option value="15">15s - Quick Hook</option>
                                <option value="25" selected>25s - Fast Facts</option>
                                <option value="30">30s - Single Topic</option>
                                <option value="45">45s - Extended</option>
                                <option value="60">60s - Deep Dive</option>
                                <option value="90">90s - Full Story</option>
                            </optgroup>
                            <optgroup label="üìñ Long-Form Stories (2-5 min)">
                                <option value="120">2 min - Short Story</option>
                                <option value="180">3 min - Full Narrative</option>
                                <option value="240">4 min - Extended Investigation</option>
                                <option value="300">5 min - Epic Tale</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="options-grid">
                    <div class="form-group">
                        <label>Transition Effect</label>
                        <select id="transition">
                            <option value="none">No Transition (Cut)</option>
                            <option value="fade">Fade</option>
                            <option value="slideright">Slide Right</option>
                            <option value="slideleft">Slide Left</option>
                            <option value="wiperight">Wipe Right</option>
                            <option value="dissolve">Dissolve</option>
                            <option value="circleopen">Circle Open</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Caption Style</label>
                        <select id="caption_style">
                            <option value="none">No Captions</option>
                            <option value="bounce" selected>Bounce (4 words)</option>
                            <option value="color_box">Color Box (4 words)</option>
                            <option value="yellow_box">Yellow Box (3-4 words)</option>
                            <option value="white_box">White Box (3-4 words)</option>
                            <option value="single_pop">Single Word Pop</option>
                            <option value="karaoke">Karaoke</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Logo Overlay</label>
                        <select id="logo_option">
                            <option value="none" selected>No Logo</option>
                            <option value="default">Default Logo</option>
                            <option value="upload">Upload Logo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="logoUploadSection" style="display: none;">
                    <label>Upload Logo (PNG/JPG)</label>
                    <div class="upload-area" onclick="document.getElementById('logoFile').click()">
                        <input type="file" id="logoFile" accept="image/png,image/jpeg,image/jpg" onchange="handleLogoUpload(event)">
                        <span class="upload-label">üìÅ Click to upload PNG or JPG</span>
                        <span class="file-name" id="logoFileName"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label>End Card</label>
                    <select id="end_card_option">
                        <option value="enabled" selected>Show End Card (3s at end)</option>
                        <option value="disabled">No End Card</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        Hook Segment 
                        <span style="cursor: help; margin-left: 6px;" title="Grabs attention in first 2-4 seconds - proven to boost watch time & engagement">‚ö°</span>
                    </label>
                    <select id="hook_option">
                        <option value="enabled" selected>Include Hook (2-4s intro)</option>
                        <option value="disabled">No Hook (Start with body)</option>
                    </select>
                    <div style="margin-top: 6px; font-size: 12px; color: #666;">
                        üí° Hooks grab attention in the first seconds to maximize viewer retention
                    </div>
                </div>

                <div class="form-group">
                    <label>Platform</label>
                    <select id="platform">
                        <option value="tiktok">TikTok (9:16)</option>
                        <option value="youtube_shorts">YouTube Shorts (9:16)</option>
                        <option value="instagram_reel">Instagram Reel (9:16)</option>
                        <option value="youtube">YouTube (16:9)</option>
                        <option value="instagram_feed">Instagram Feed (1:1)</option>
                    </select>
                </div>

                <div class="feature-tags">
                    <span class="tag">‚ú® AI Script</span>
                    <span class="tag">üé§ Voice Synthesis</span>
                    <span class="tag">üì∏ Auto Images</span>
                    <span class="tag">üé¨ Pro Transitions</span>
                    <span class="tag">üí¨ Captions</span>
                </div>

                <button type="submit" class="btn" id="generateBtn">
                    üöÄ Generate Video
                </button>
            </form>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-stage" id="progressStage">Initializing...</div>
            </div>

            <!-- Hook preview section -->
            <div id="hookSection" class="card" style="display:none; padding:20px; margin-top:20px;">
                <div class="section-title">‚ö° Hook</div>
                <div id="selectedHookWrap" style="margin-top:10px;">
                    <div style="font-weight:600; color:#333;">Selected Hook</div>
                    <div id="selectedHookText" style="margin-top:6px; padding:12px; border-radius:10px; background:#f7f7ff; border:1px solid #e6e8ff; color:#222;"></div>
                    <div style="margin-top:6px; font-size:12px; color:#666;" id="hookMeta">Auto-selected for attention optimization</div>
                </div>
                <div id="hookOptionsWrap" style="margin-top:16px;">
                    <div style="font-weight:600; color:#333;">Other Options</div>
                    <div id="hookOptions" style="margin-top:8px;"></div>
                </div>
            </div>

            <div class="error" id="errorContainer"></div>

            <div class="result-container" id="resultContainer">
                <h2 style="color: #10b981; margin-bottom: 20px;">‚úÖ Video Ready!</h2>
                <div class="video-preview">
                    <video id="videoPreview" controls autoplay loop>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <button class="btn download-btn" id="downloadBtn">‚¨áÔ∏è Download Video</button>
            </div>
        </div>
    </div>

    <script>
        let currentStories = [];
        let currentCategory = 'mystery';

        function fillTopic(topic) {
            document.getElementById('topic').value = topic;
        }

        // Toggle between manual topic entry and fetched stories
        function toggleTopicSource() {
            const source = document.getElementById('content_source').value;
            const manualSection = document.getElementById('manualTopicSection');
            const fetchedSection = document.getElementById('fetchedTopicSection');
            
            if (source === 'manual') {
                manualSection.style.display = 'block';
                fetchedSection.style.display = 'none';
                document.getElementById('topic').required = true;
            } else {
                manualSection.style.display = 'none';
                fetchedSection.style.display = 'block';
                document.getElementById('topic').required = false;
                
                // Auto-select appropriate style
                const styleSelect = document.getElementById('style');
                if (source === 'mystery') {
                    styleSelect.value = 'mystery_investigation';
                } else if (source === 'dark') {
                    styleSelect.value = 'true_crime';
                }
                
                // Fetch stories for the selected category
                currentCategory = source;
                fetchStories(source);
            }
        }

        // Fetch stories from backend
        async function fetchStories(category) {
            const select = document.getElementById('fetched_topic');
            const countSpan = document.getElementById('storyCount');
            
            select.innerHTML = '<option disabled selected>‚è≥ Loading stories...</option>';
            
            try {
                const response = await fetch(`/api/fetch-stories?category=${category}&limit=20`);
                const data = await response.json();
                
                currentStories = data.stories;
                
                if (currentStories.length === 0) {
                    select.innerHTML = '<option disabled>No stories found</option>';
                    return;
                }
                
                // Populate dropdown
                select.innerHTML = '<option value="" disabled selected>üëá Select a story to preview</option>';
                currentStories.forEach((story, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    
                    // Format: Just the title (clean, no fake metrics)
                    option.textContent = story.title.length > 100 ? story.title.substring(0, 97) + '...' : story.title;
                    option.setAttribute('data-full-content', story.full_content || story.content);
                    
                    select.appendChild(option);
                });
                
                countSpan.textContent = `${currentStories.length} stories loaded`;
                
            } catch (error) {
                console.error('Failed to fetch stories:', error);
                select.innerHTML = '<option disabled>‚ùå Failed to load stories. Try again.</option>';
            }
        }

        // Refresh stories
        function refreshStories() {
            fetchStories(currentCategory);
        }

        // Show story preview when selected
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('fetched_topic');
            
            select.addEventListener('change', function(e) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const fullContent = selectedOption.getAttribute('data-full-content');
                
                const previewDiv = document.getElementById('story_preview');
                const previewText = document.getElementById('story_preview_text');
                const metaDiv = document.getElementById('story_meta');
                
                if (fullContent) {
                    const preview = fullContent.substring(0, 300);
                    previewText.textContent = preview + (fullContent.length > 300 ? '...' : '');
                    
                    // Remove fake engagement metrics
                    metaDiv.innerHTML = `üìñ Story preview`;
                    
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
            });

            // Handle logo option change
            document.getElementById('logo_option').addEventListener('change', function(e) {
                const uploadSection = document.getElementById('logoUploadSection');
                if (e.target.value === 'upload') {
                    uploadSection.style.display = 'block';
                } else {
                    uploadSection.style.display = 'none';
                }
            });

            document.getElementById('skip_ai').addEventListener('change', handleSkipAiToggle);
            document.getElementById('skip_captions').addEventListener('change', handleSkipCaptionsToggle);

            // Rotate Pro Tips
            const proTips = [
                'Paste a full story for precise script, or just enter a topic/concept and let AI expand it',
                'Upload your own videos under Content Type ‚Üí Upload My Own Videos for best control',
                'Set Transition to Dissolve for smooth, professional scene changes',
                'Use Skip Captions for clean visuals when your audio already has narration',
                'Replace audio with music to create montage-style videos',
                'Choose Duration that matches platform: 25‚Äì30s is ideal for Shorts/Reels',
                'Set Logo Overlay to No Logo for brand-free exports',
                'Mix background music at Medium for balanced voice + music'
            ];
            let tipIdx = 0;
            const tipEl = document.getElementById('proTipText');
            function rotateTip() {
                // fade out
                tipEl.style.opacity = '0';
                setTimeout(() => {
                    tipIdx = (tipIdx + 1) % proTips.length;
                    tipEl.textContent = proTips[tipIdx];
                    // fade in
                    tipEl.style.opacity = '1';
                }, 350);
            }
            // Start rotation every 12 seconds
            setInterval(rotateTip, 12000);
        });

        let currentJobId = null;
        let uploadedLogo = null;
        let uploadedImages = [];
        let uploadedVideos = [];
        let uploadedCustomAudio = null;
        let previousCaptionStyle = null;
        let skipCaptionsPreviousState = false;
        let previousAudioSource = 'none';

        function fillTopic(topic) {
            document.getElementById('topic').value = topic;
        }

        function toggleAudioUpload() {
            const audioSource = document.getElementById('audio_source').value;
            const uploadSection = document.getElementById('audioUploadSection');
            if (audioSource !== 'none') {
                uploadSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'none';
            }
        }

        function handleCustomAudioUpload(event) {
            const file = event.target.files[0];
            if (file) {
                uploadedCustomAudio = file;
                document.getElementById('customAudioFileName').textContent = '‚úì ' + file.name;
            }
        }

        // Handle content type change
        function toggleUploadSections() {
            const contentType = document.getElementById('content_type').value;
            const imageSection = document.getElementById('imageUploadSection');
            const videoSection = document.getElementById('videoUploadSection');
            
            imageSection.style.display = 'none';
            videoSection.style.display = 'none';
            
            if (contentType === 'upload_images' || contentType === 'upload_both') {
                imageSection.style.display = 'block';
            }
            if (contentType === 'upload_videos' || contentType === 'upload_both') {
                videoSection.style.display = 'block';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                uploadedLogo = file;
                document.getElementById('logoFileName').textContent = '‚úì ' + file.name;
            }
        }

        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                uploadedImages = files;
                document.getElementById('imageFileNames').textContent = '‚úì ' + files.length + ' image(s) selected';
            }
        }

        function handleVideoUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                uploadedVideos = files;
                document.getElementById('videoFileNames').textContent = '‚úì ' + files.length + ' video(s) selected';
            }
        }

        document.getElementById('videoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get topic from either manual input or selected story
            let topic;
            const contentSource = document.getElementById('content_source').value;
            const skipAI = document.getElementById('skip_ai').checked;
            
            if (contentSource === 'manual') {
                topic = document.getElementById('topic').value;
                if (!topic && !skipAI) {
                    showError('Please enter a topic or story');
                    resetForm();
                    return;
                }
            } else {
                // Get from selected story
                const select = document.getElementById('fetched_topic');
                const selectedIdx = select.value;
                
                if (!selectedIdx || selectedIdx === '') {
                    showError('Please select a story from the list');
                    resetForm();
                    return;
                }
                
                const selectedStory = currentStories[selectedIdx];
                // Use full content as topic for AI script generation
                topic = `${selectedStory.title}\n\n${selectedStory.full_content || selectedStory.content}`;
            }

            const platform = document.getElementById('platform').value;
            const style = document.getElementById('style').value;
            const voice = document.getElementById('voice').value;
            const duration = document.getElementById('duration').value;
            const transition = document.getElementById('transition').value;
            const logoOption = document.getElementById('logo_option').value;
            const endCardOption = document.getElementById('end_card_option').value;
            const hookOption = document.getElementById('hook_option').value;
            const captionStyle = document.getElementById('caption_style').value;
            const contentType = document.getElementById('content_type').value;
            const logoFile = document.getElementById('logoFile').files[0];
            const imageFiles = document.getElementById('imageFiles').files;
            const videoFiles = document.getElementById('videoFiles').files;
            const audioSource = document.getElementById('audio_source').value;
            const customAudioFile = document.getElementById('customAudioFile').files[0];
            const skipCaptions = document.getElementById('skip_captions').checked;

            if (skipAI) {
                if (audioSource !== 'replace') {
                    showError('Skip AI requires audio source set to "Replace" with a custom audio file.');
                    resetForm();
                    return;
                }
                if (!customAudioFile) {
                    showError('Upload a custom audio file when Skip AI is enabled.');
                    resetForm();
                    return;
                }
            }

            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = '‚è≥ Generating...';
            document.getElementById('errorContainer').style.display = 'none';

            try {
                // Check if we need to send form data (for file uploads) or JSON
                let body, headers;
                const needsFormData = (logoOption === 'upload' && logoFile) || 
                                     (contentType === 'upload_images' && imageFiles.length > 0) ||
                                     (contentType === 'upload_videos' && videoFiles.length > 0) ||
                                     (contentType === 'upload_both' && (imageFiles.length > 0 || videoFiles.length > 0)) ||
                                     (audioSource !== 'none' && customAudioFile);
                
                if (needsFormData) {
                    // Use FormData for file upload
                    const formData = new FormData();
                    formData.append('topic', topic);
                    formData.append('platform', platform);
                    formData.append('style', style);
                    formData.append('voice', voice);
                    formData.append('duration', duration);
                    formData.append('transition', transition);
                    formData.append('logo_option', logoOption);
                    formData.append('end_card_option', endCardOption);
                    formData.append('hook_option', hookOption);
                    formData.append('caption_style', captionStyle);
                    formData.append('content_type', contentType);
                    formData.append('skip_ai', skipAI ? 'true' : 'false');
                    formData.append('skip_captions', skipCaptions ? 'true' : 'false');
                    formData.append('audio_source', audioSource);
                    
                    if (logoFile) {
                        formData.append('logo_file', logoFile);
                    }
                    
                    if (customAudioFile && audioSource !== 'none') {
                        formData.append('custom_audio_file', customAudioFile);
                    }
                    
                    // Append uploaded images
                    if ((contentType === 'upload_images' || contentType === 'upload_both') && imageFiles.length > 0) {
                        for (let i = 0; i < imageFiles.length; i++) {
                            formData.append('image_files', imageFiles[i]);
                        }
                    }
                    
                    // Append uploaded videos
                    if ((contentType === 'upload_videos' || contentType === 'upload_both') && videoFiles.length > 0) {
                        for (let i = 0; i < videoFiles.length; i++) {
                            formData.append('video_files', videoFiles[i]);
                        }
                    }
                    
                    body = formData;
                    headers = {}; // Let browser set Content-Type with boundary
                } else {
                    // Use JSON
                    body = JSON.stringify({
                        topic,
                        platform,
                        style,
                        voice,
                        duration,
                        transition,
                        logo_option: logoOption,
                        end_card_option: endCardOption,
                        hook_option: hookOption,
                        caption_style: captionStyle,
                        content_type: contentType,
                        skip_ai: skipAI ? 'true' : 'false',
                        skip_captions: skipCaptions ? 'true' : 'false',
                        audio_source: audioSource
                    });
                    headers = { 'Content-Type': 'application/json' };
                }

                // Start generation
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                // Read raw response and try to parse JSON; fall back to text
                const raw = await response.text();
                let data;
                try {
                    data = JSON.parse(raw);
                } catch (e) {
                    // Surface a concise server message if available
                    const snippet = raw ? raw.substring(0, 200) : '';
                    throw new Error(snippet || 'Server error - please try again');
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start generation');
                }

                currentJobId = data.job_id;

                // Poll for status
                pollStatus();

            } catch (error) {
                showError(error.message);
                resetForm();
            }
        });

        function handleSkipAiToggle(event) {
            const skipCaptionsBox = document.getElementById('skip_captions');
            const topicField = document.getElementById('topic');
            const audioSelect = document.getElementById('audio_source');
            if (event.target.checked) {
                if (!skipCaptionsBox.disabled) {
                    skipCaptionsPreviousState = skipCaptionsBox.checked;
                }
                skipCaptionsBox.checked = true;
                skipCaptionsBox.disabled = true;
                handleSkipCaptionsToggle({ target: skipCaptionsBox });
                topicField.required = false;

                if (!audioSelect.disabled) {
                    previousAudioSource = audioSelect.value;
                }
                audioSelect.value = 'replace';
                audioSelect.disabled = true;
                toggleAudioUpload();
            } else {
                skipCaptionsBox.disabled = false;
                skipCaptionsBox.checked = skipCaptionsPreviousState;
                handleSkipCaptionsToggle({ target: skipCaptionsBox });
                if (document.getElementById('content_source').value === 'manual') {
                    topicField.required = true;
                }
                audioSelect.disabled = false;
                audioSelect.value = previousAudioSource || 'none';
                toggleAudioUpload();
            }
        }

        function handleSkipCaptionsToggle(event) {
            const captionSelect = document.getElementById('caption_style');
            if (event.target.checked) {
                if (!captionSelect.disabled) {
                    previousCaptionStyle = captionSelect.value;
                }
                captionSelect.value = 'none';
                captionSelect.disabled = true;
            } else {
                captionSelect.disabled = false;
                if (previousCaptionStyle && previousCaptionStyle !== 'none') {
                    captionSelect.value = previousCaptionStyle;
                }
            }
        }

        async function pollStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/status/${currentJobId}`);
                const data = await response.json();

                // Update progress
                const progressVal = (typeof data.progress === 'number')
                    ? data.progress
                    : (isNaN(parseInt(data.progress)) ? 0 : parseInt(data.progress));
                document.getElementById('progressFill').style.width = progressVal + '%';
                document.getElementById('progressFill').textContent = progressVal + '%';
                document.getElementById('progressStage').textContent = data.stage || 'Processing...';

                // Show Hook card when available
                try {
                    const hookSection = document.getElementById('hookSection');
                    if (data.selected_hook || (data.hook_options && data.hook_options.length)) {
                        hookSection.style.display = 'block';
                        const selectedEl = document.getElementById('selectedHookText');
                        selectedEl.textContent = data.selected_hook || '';

                        const optionsEl = document.getElementById('hookOptions');
                        optionsEl.innerHTML = '';
                        const opts = (data.hook_options || []).slice(0,3);
                        opts.forEach((opt, idx) => {
                            const row = document.createElement('div');
                            row.style.display = 'flex';
                            row.style.alignItems = 'center';
                            row.style.gap = '8px';
                            row.style.marginBottom = '6px';
                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = 'hookOption';
                            radio.disabled = true; // Free tier: locked to auto-selected
                            radio.checked = (opt === data.selected_hook);
                            const label = document.createElement('label');
                            label.textContent = opt;
                            label.style.color = '#444';
                            label.style.fontSize = '14px';
                            row.appendChild(radio);
                            row.appendChild(label);
                            optionsEl.appendChild(row);
                        });
                    }
                } catch (e) {
                    console.warn('Hook UI update failed:', e);
                }

                if (data.status === 'completed') {
                    // Show video
                    showVideo();
                } else if (data.status === 'failed') {
                    throw new Error(data.error || 'Video generation failed');
                } else {
                    // Continue polling
                    setTimeout(pollStatus, 2000);
                }

            } catch (error) {
                showError(error.message);
                resetForm();
            }
        }

        function showVideo() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';
            
            const streamUrl = `/api/video/${currentJobId}`;
            const downloadUrl = `/api/download/${currentJobId}`;
            
            document.getElementById('videoPreview').src = streamUrl;
            
            document.getElementById('downloadBtn').onclick = () => {
                window.location.href = downloadUrl;
            };
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = '‚ùå Error: ' + message;
            errorContainer.style.display = 'block';
        }

        function resetForm() {
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = 'üöÄ Generate Video';
            document.getElementById('progressContainer').style.display = 'none';
        }
    </script>
</body>
</html>
